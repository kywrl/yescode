#!/usr/bin/env bash
# YesCode CLI
# ä¾èµ–: curl, jq

set -e

# ============================================================
# é¢œè‰²å®šä¹‰
# ============================================================

# ANSI é¢œè‰²ç 
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
RESET='\033[0m'

# ============================================================
# é…ç½®ç®¡ç†
# ============================================================

prompt_api_key() {
    local show_message="${1:-true}"  # é»˜è®¤æ˜¾ç¤ºæç¤ºä¿¡æ¯
    local config_dir="$HOME/.yescode"
    local config_file="$config_dir/config.json"

    if [[ "$show_message" == "true" ]]; then
        echo
        echo -e "${YELLOW}æœªé…ç½® API Key${RESET}"
        echo
    fi

    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p "$config_dir"

    # æç¤ºç”¨æˆ·è¾“å…¥
    read -p "è¯·è¾“å…¥æ‚¨çš„ API Key: " api_key

    # éªŒè¯è¾“å…¥
    if [[ -z "$api_key" ]]; then
        echo -e "${RED}é”™è¯¯: API Key ä¸èƒ½ä¸ºç©º${RESET}"
        exit 1
    fi

    # ä¿å­˜é…ç½®
    echo "{\"api_key\": \"$api_key\"}" > "$config_file"
    chmod 600 "$config_file"

    echo -e "${GREEN}âœ“ é…ç½®å·²ä¿å­˜åˆ°: $config_file${RESET}"
    echo
}

load_config() {
    local config_file="$HOME/.yescode/config.json"

    # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
    if [[ ! -f "$config_file" ]]; then
        prompt_api_key
    fi

    # ä½¿ç”¨ jq è¯»å– API Key
    API_KEY=$(jq -r '.api_key' "$config_file" 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯${RESET}"
        echo "è¯·ç¡®ä¿ $config_file æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
        exit 1
    fi

    # å¦‚æœ API Key ä¸ºç©ºæˆ– nullï¼Œæç¤ºç”¨æˆ·è¾“å…¥
    if [[ -z "$API_KEY" || "$API_KEY" == "null" ]]; then
        prompt_api_key
        # é‡æ–°è¯»å–é…ç½®
        API_KEY=$(jq -r '.api_key' "$config_file" 2>/dev/null)
    fi

    # å›ºå®šçš„ API Base URL
    API_BASE_URL="https://co.yes.vg"
}

# ============================================================
# Loading åŠ¨ç”»å‡½æ•°
# ============================================================

show_loading() {
    local pid=$1
    local spin='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    local i=0

    # debug æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºåŠ¨ç”»ï¼Œç›´æ¥ç­‰å¾…
    if [[ "$DEBUG" == "true" ]]; then
        wait $pid
        return
    fi

    # éšè—å…‰æ ‡
    tput civis

    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) % 10 ))
        printf "\r${CYAN}${spin:$i:1}${RESET}"
        sleep 0.1
    done

    # æ¸…é™¤loadingè¡Œ
    printf "\r\033[K"

    # æ¢å¤å…‰æ ‡
    tput cnorm
}

# ============================================================
# Debug æ¨¡å¼æ˜¾ç¤ºå‡½æ•°
# ============================================================

display_raw_response() {
    # åªåœ¨ debug æ¨¡å¼ä¸‹æ˜¾ç¤º
    if [[ "$DEBUG" != "true" ]]; then
        return
    fi

    local method="$1"
    local url="$2"
    local api_key_masked="$3"
    local http_code="$4"
    local headers="$5"
    local body="$6"
    local request_body="$7"  # å¯é€‰çš„è¯·æ±‚ä½“

    # æ‰€æœ‰è¾“å‡ºé‡å®šå‘åˆ° stderrï¼Œé¿å…æ±¡æŸ“ API å‡½æ•°çš„è¿”å›å€¼
    {
        echo
        echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• åŸå§‹ HTTP è¯·æ±‚/å“åº” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo
        echo -e "${CYAN}${BOLD}ğŸ“¤ è¯·æ±‚ä¿¡æ¯${RESET}"
        echo -e "  æ–¹æ³•: ${YELLOW}${method}${RESET}"
        echo -e "  URL: ${BLUE}${url}${RESET}"
        echo -e "  è¯·æ±‚å¤´:"
        echo -e "    ${WHITE}accept: application/json${RESET}"
        echo -e "    ${WHITE}X-API-Key: ${api_key_masked}${RESET}"
        if [[ "$method" == "PUT" || "$method" == "POST" ]]; then
            echo -e "    ${WHITE}Content-Type: application/json${RESET}"
        fi

        # æ˜¾ç¤ºè¯·æ±‚ä½“ï¼ˆå¦‚æœæœ‰ï¼‰
        if [[ -n "$request_body" ]]; then
            echo
            echo -e "${CYAN}${BOLD}ğŸ“„ è¯·æ±‚ä½“ï¼ˆJSONï¼‰:${RESET}"
            if command -v jq &> /dev/null; then
                echo "$request_body" | jq -C . 2>/dev/null || echo "$request_body"
            else
                echo "$request_body"
            fi
        fi
        echo
        echo -e "${CYAN}${BOLD}ğŸ“¥ å“åº”ä¿¡æ¯${RESET}"
        echo -e "  çŠ¶æ€ç : ${GREEN}${http_code}${RESET}"

        if [[ -n "$headers" && "$headers" != "null" ]]; then
            echo -e "  å“åº”å¤´:"
            echo "$headers" | while IFS= read -r line; do
                if [[ -n "$line" ]]; then
                    echo -e "    ${WHITE}${line}${RESET}"
                fi
            done
        fi

        echo
        echo -e "${CYAN}${BOLD}ğŸ“„ å“åº”ä½“ï¼ˆJSONï¼‰:${RESET}"

        # ä½¿ç”¨ jq æ ¼å¼åŒ– JSONï¼ˆå¸¦é¢œè‰²ï¼‰
        if command -v jq &> /dev/null; then
            echo "$body" | jq -C . 2>/dev/null || echo "$body"
        else
            echo "$body"
        fi

        echo
        echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo
    } >&2
}

# ============================================================
# é¢œè‰²å·¥å…·å‡½æ•°
# ============================================================

get_balance_color() {
    local balance=$1
    local threshold_low=20
    local threshold_medium=50

    if (( $(echo "$balance < $threshold_low" | bc -l) )); then
        echo "$RED"
    elif (( $(echo "$balance < $threshold_medium" | bc -l) )); then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

get_spending_color() {
    local spent_percent=$1

    if (( $(echo "$spent_percent >= 95" | bc -l) )); then
        echo "$RED"
    elif (( $(echo "$spent_percent >= 80" | bc -l) )); then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

create_progress_bar() {
    local current=$1
    local total=$2
    local width=30

    if (( $(echo "$total == 0" | bc -l) )); then
        local percent=0
        local filled=0
    else
        local percent=$(echo "scale=1; ($current / $total) * 100" | bc)
        local filled=$(echo "scale=0; ($current / $total) * $width" | bc)
    fi

    local empty=$((width - filled))
    local bar=$(printf 'â–ˆ%.0s' $(seq 1 $filled))$(printf 'â–‘%.0s' $(seq 1 $empty))

    local color=$(get_spending_color "$percent")
    echo -e "[${color}${bar}${RESET}] ${color}${BOLD}${percent}%${RESET}"
}

# ============================================================
# ç³»ç»Ÿæ£€æµ‹ä¸ä¾èµ–å®‰è£…
# ============================================================

detect_package_manager() {
    # æ£€æµ‹ç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨å¹¶è¿”å›å®‰è£…å‘½ä»¤
    if command -v apt &> /dev/null; then
        echo "apt"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v yum &> /dev/null; then
        echo "yum"
    elif command -v brew &> /dev/null; then
        echo "brew"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v zypper &> /dev/null; then
        echo "zypper"
    else
        echo "unknown"
    fi
}

auto_install_dependency() {
    local dep=$1
    local pkg_manager=$(detect_package_manager)

    if [[ "$pkg_manager" == "unknown" ]]; then
        return 1
    fi

    read -p "æ˜¯å¦è‡ªåŠ¨å®‰è£… $dep? (y/n): " -r

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        return 1
    fi

    echo "æ­£åœ¨å®‰è£… $dep..."

    local install_cmd=""
    case "$pkg_manager" in
        apt)
            install_cmd="sudo apt install -y $dep"
            ;;
        dnf)
            install_cmd="sudo dnf install -y $dep"
            ;;
        yum)
            install_cmd="sudo yum install -y $dep"
            ;;
        brew)
            install_cmd="brew install $dep"
            ;;
        pacman)
            install_cmd="sudo pacman -S --noconfirm $dep"
            ;;
        zypper)
            install_cmd="sudo zypper install -y $dep"
            ;;
    esac

    if eval "$install_cmd"; then
        echo -e "${GREEN}âœ“ $dep å®‰è£…æˆåŠŸ${RESET}"
        return 0
    else
        echo -e "${RED}âœ— $dep å®‰è£…å¤±è´¥${RESET}"
        return 1
    fi
}

# ============================================================
# API è°ƒç”¨å‡½æ•°
# ============================================================

api_get_balance() {
    local url="${API_BASE_URL}/api/v1/user/balance"
    local method="GET"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        # debug æ¨¡å¼ï¼šè·å–å“åº”å¤´
        response=$(curl -s -i -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        # æ™®é€šæ¨¡å¼ï¼šä¸è·å–å“åº”å¤´
        response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        # åˆ é™¤å›è½¦ç¬¦ï¼ˆHTTP å“åº”ä½¿ç”¨ CRLFï¼‰
        full_response=$(echo "$full_response" | tr -d '\r')
        # æŸ¥æ‰¾ç©ºè¡Œä½ç½®ï¼ˆå“åº”å¤´å’Œå“åº”ä½“çš„åˆ†éš”ï¼‰
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç©ºè¡Œï¼Œå¯èƒ½å“åº”æ ¼å¼å¼‚å¸¸ï¼Œå…¨éƒ¨ä½œä¸º body
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–ä½™é¢å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body"
    fi

    echo "$body"
}

api_get_providers() {
    local url="${API_BASE_URL}/api/v1/user/available-providers"
    local method="GET"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–åˆ†ç»„ä¿¡æ¯å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body"
    fi

    echo "$body"
}

api_get_provider_alternatives() {
    local provider_id=$1

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: provider_id ä¸èƒ½ä¸ºç©º${RESET}" >&2
        return 1
    fi

    local url="${API_BASE_URL}/api/v1/user/provider-alternatives/${provider_id}"
    local method="GET"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–åˆ†ç»„å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body"
    fi

    echo "$body"
}

api_get_provider_selection() {
    local provider_id=$1

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: provider_id ä¸èƒ½ä¸ºç©º${RESET}" >&2
        return 1
    fi

    local url="${API_BASE_URL}/api/v1/user/provider-alternatives/${provider_id}/selection"
    local method="GET"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–å½“å‰é€‰æ‹©å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body"
    fi

    echo "$body"
}

api_set_provider_selection() {
    local provider_id=$1
    local selected_alternative_id=$2

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: provider_id ä¸èƒ½ä¸ºç©º${RESET}" >&2
        return 1
    fi

    if [[ -z "$selected_alternative_id" ]]; then
        echo -e "${RED}é”™è¯¯: selected_alternative_id ä¸èƒ½ä¸ºç©º${RESET}" >&2
        return 1
    fi

    local url="${API_BASE_URL}/api/v1/user/provider-alternatives/${provider_id}/selection"
    local method="PUT"
    local json_data="{\"selected_alternative_id\": ${selected_alternative_id}}"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X PUT \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "$json_data" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "$json_data" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è®¾ç½®é€‰æ‹©å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body" "$json_data"
    fi

    echo "$body"
}

api_set_balance_preference() {
    local balance_preference=$1

    if [[ -z "$balance_preference" ]]; then
        echo -e "${RED}é”™è¯¯: balance_preference ä¸èƒ½ä¸ºç©º${RESET}" >&2
        return 1
    fi

    # éªŒè¯å‚æ•°å€¼
    if [[ "$balance_preference" != "subscription_first" && "$balance_preference" != "payg_only" ]]; then
        echo -e "${RED}é”™è¯¯: balance_preference åªèƒ½æ˜¯ 'subscription_first' æˆ– 'payg_only'${RESET}" >&2
        return 1
    fi

    local url="${API_BASE_URL}/api/v1/user/balance-preference"
    local method="PUT"
    local json_data="{\"balance_preference\": \"${balance_preference}\"}"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X PUT \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "$json_data" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "$json_data" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è®¾ç½®ä½™é¢ä½¿ç”¨åå¥½å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body" "$json_data"
    fi

    echo "$body"
}

api_get_profile() {
    local url="${API_BASE_URL}/api/v1/auth/profile"
    local method="GET"

    # æ ¹æ® debug æ¨¡å¼é€‰æ‹©ä¸åŒçš„ curl å‚æ•°
    local response
    if [[ "$DEBUG" == "true" ]]; then
        response=$(curl -s -i -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "accept: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>&1)
    fi

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local full_response=$(echo "$response" | head -n -1)

    # åœ¨ debug æ¨¡å¼ä¸‹åˆ†ç¦»å“åº”å¤´å’Œå“åº”ä½“
    local headers=""
    local body=""
    if [[ "$DEBUG" == "true" ]]; then
        full_response=$(echo "$full_response" | tr -d '\r')
        local empty_line=$(echo "$full_response" | grep -n "^$" | head -1 | cut -d: -f1)
        if [[ -n "$empty_line" ]]; then
            headers=$(echo "$full_response" | head -n $((empty_line - 1)))
            body=$(echo "$full_response" | tail -n +$((empty_line + 1)))
        else
            body="$full_response"
        fi
    else
        body="$full_response"
    fi

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ "$http_code" == "401" ]]; then
        echo "AUTH_ERROR_401"
        return 2
    fi

    # å¤„ç†å…¶ä»–é”™è¯¯
    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    # æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆä»…åœ¨ debug æ¨¡å¼ï¼‰
    if [[ "$DEBUG" == "true" ]]; then
        local api_key_masked="${API_KEY:0:8}********"
        display_raw_response "$method" "$url" "$api_key_masked" "$http_code" "$headers" "$body"
    fi

    echo "$body"
}

# ============================================================
# æ˜¾ç¤ºä½™é¢ä¿¡æ¯
# ============================================================

display_balance_info() {
    local data=$1

    # ä½¿ç”¨ jq æå–æ•°æ®
    local subscription_balance=$(echo "$data" | jq -r '.subscription_balance // 0')
    local payg_balance=$(echo "$data" | jq -r '.pay_as_you_go_balance // 0')
    local total_balance=$(echo "$data" | jq -r '.total_balance // 0')
    local credit_balance=$(echo "$data" | jq -r '.credit_balance // 0')
    local weekly_limit=$(echo "$data" | jq -r '.weekly_limit // 0')
    local weekly_spent=$(echo "$data" | jq -r '.weekly_spent_balance // 0')

    # è®¡ç®—å‰©ä½™é¢åº¦å’Œæ¶ˆè´¹ç™¾åˆ†æ¯”
    local weekly_remaining=$(echo "$weekly_limit - $weekly_spent" | bc)
    if (( $(echo "$weekly_limit > 0" | bc -l) )); then
        local spent_percent=$(echo "scale=1; ($weekly_spent / $weekly_limit) * 100" | bc)
        local remaining_percent=$(echo "scale=1; 100 - $spent_percent" | bc)
    else
        local spent_percent=0
        local remaining_percent=0
    fi

    # æ˜¾ç¤ºä½™é¢ä¿¡æ¯
    echo -e "${CYAN}${BOLD}ğŸ’° ä½™é¢ä¿¡æ¯${RESET}"

    if [[ "$subscription_balance" != "0" ]]; then
        local color=$(get_balance_color "$subscription_balance")
        echo -e "è®¢é˜…ä½™é¢ï¼š${color}\$$(printf "%.2f" $subscription_balance)${RESET}"
    fi

    if [[ "$payg_balance" != "0" ]]; then
        local color=$(get_balance_color "$payg_balance")
        echo -e "æŒ‰éœ€ä»˜è´¹ä½™é¢ï¼š${color}\$$(printf "%.2f" $payg_balance)${RESET}"
    fi

    if [[ "$total_balance" != "0" ]]; then
        local color=$(get_balance_color "$total_balance")
        echo -e "${WHITE}${BOLD}æ€»ä½™é¢ï¼š${RESET}${color}${BOLD}\$$(printf "%.2f" $total_balance)${RESET}"
    fi

    if (( $(echo "$credit_balance > 0" | bc -l) )); then
        echo -e "ä¿¡ç”¨é¢åº¦ï¼š${MAGENTA}\$$(printf "%.2f" $credit_balance)${RESET}"
    fi

    # æ˜¾ç¤ºæ¶ˆè´¹ä¿¡æ¯
    echo
    echo -e "${CYAN}${BOLD}ğŸ“Š æœ¬å‘¨æ¶ˆè´¹${RESET}"

    if (( $(echo "$weekly_limit > 0" | bc -l) )); then
        echo -e "å‘¨é™é¢ï¼š${CYAN}\$$(printf "%.2f" $weekly_limit)${RESET}"

        local color=$(get_spending_color "$spent_percent")
        echo -e "å·²æ¶ˆè´¹ï¼š${color}\$$(printf "%.2f" $weekly_spent)${RESET} ${color}(${spent_percent}%)${RESET}"

        local remaining_color=$(get_balance_color "$weekly_remaining")
        echo -e "å‰©ä½™é¢åº¦ï¼š${remaining_color}\$$(printf "%.2f" $weekly_remaining)${RESET} ${remaining_color}(${remaining_percent}%)${RESET}"

        echo -e "æ¶ˆè´¹è¿›åº¦ï¼š$(create_progress_bar "$weekly_spent" "$weekly_limit")"
    fi
}

display_providers_info() {
    local data=$1

    # æå–è´¦æˆ·ä¿¡æ¯
    local has_payg=$(echo "$data" | jq -r '.has_payg_balance')
    local has_subscription=$(echo "$data" | jq -r '.has_subscription')

    # æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€
    echo -e "${CYAN}${BOLD}ğŸ”Œ å¯ç”¨åˆ†ç»„${RESET}"
    echo

    # ä½¿ç”¨ jq è§£æ providers æ•°ç»„
    local providers_count=$(echo "$data" | jq '.providers | length')

    for ((i=0; i<$providers_count; i++)); do
        local provider_data=$(echo "$data" | jq -r ".providers[$i]")

        local provider_id=$(echo "$provider_data" | jq -r '.provider.id')
        local display_name=$(echo "$provider_data" | jq -r '.provider.display_name')
        local type=$(echo "$provider_data" | jq -r '.provider.type')
        local rate=$(echo "$provider_data" | jq -r '.rate_multiplier')
        local is_default=$(echo "$provider_data" | jq -r '.is_default')
        local source=$(echo "$provider_data" | jq -r '.source')

        # è½¬æ¢ source ä¸ºä¸­æ–‡
        local source_text=""
        if [[ "$source" == "subscription" ]]; then
            source_text="${CYAN}è®¢é˜…${RESET}"
        else
            source_text="${YELLOW}æŒ‰éœ€${RESET}"
        fi

        # æ˜¾ç¤ºé»˜è®¤æ ‡è®°
        local default_mark=""
        if [[ "$is_default" == "true" ]]; then
            default_mark=" ${GREEN}[é»˜è®¤]${RESET}"
        fi

        # æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯
        echo -e "${WHITE}${BOLD}${display_name}${RESET}${default_mark}"
        echo -e "ID: ${BLUE}${provider_id}${RESET} | ç±»å‹: ${type} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET} | æ¥æº: ${source_text}"
        echo
    done
}

display_provider_alternatives() {
    local data=$1
    local provider_id=$2

    # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    local data_count=$(echo "$data" | jq '.data | length')
    if [[ "$data_count" == "0" || "$data_count" == "null" ]]; then
        echo -e "${RED}é”™è¯¯: åˆ†ç»„ä¸å­˜åœ¨${RESET}"
        echo
        echo -e "${YELLOW}æç¤º: è¯·å…ˆè¿è¡Œ ${WHITE}yc providers${YELLOW} æŸ¥çœ‹å¯ç”¨çš„åˆ†ç»„ ID${RESET}"
        return 1
    fi

    # æ˜¾ç¤ºæ ‡é¢˜
    echo -e "${CYAN}${BOLD}åˆ†ç»„ ${provider_id} å¯ç”¨æä¾›å•†ï¼š${RESET}"
    echo

    # éå†æ‰€æœ‰æ–¹æ¡ˆï¼ˆåŒ…æ‹¬åŸæ–¹æ¡ˆå’Œæ›¿ä»£æ–¹æ¡ˆï¼‰
    for ((i=0; i<$data_count; i++)); do
        local item=$(echo "$data" | jq -r ".data[$i]")

        local is_self=$(echo "$item" | jq -r '.is_self')
        local provider_id=$(echo "$item" | jq -r '.alternative.id')
        local display_name=$(echo "$item" | jq -r '.alternative.display_name')
        local type=$(echo "$item" | jq -r '.alternative.type')
        local rate=$(echo "$item" | jq -r '.alternative.rate_multiplier')

        # æ ¹æ®æ˜¯å¦ä¸ºåŸæ–¹æ¡ˆæ·»åŠ ä¸åŒçš„æ ‡è®°å’Œé¢œè‰²
        if [[ "$is_self" == "true" ]]; then
            # åŸæ–¹æ¡ˆï¼šåœ¨åç§°åæ·»åŠ [é»˜è®¤]æ ‡ç­¾
            echo -e "  ID: ${BLUE}${provider_id}${RESET} | ${WHITE}${display_name}${RESET} ${GREEN}[é»˜è®¤]${RESET} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET} | ç±»å‹: ${type}"
        else
            # æ›¿ä»£æ–¹æ¡ˆï¼šæ™®é€šæ˜¾ç¤º
            echo -e "  ID: ${BLUE}${provider_id}${RESET} | ${WHITE}${display_name}${RESET} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET} | ç±»å‹: ${type}"
        fi
    done
}

display_provider_selection() {
    local data=$1

    # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    local selection_data=$(echo "$data" | jq -r '.data')
    if [[ "$selection_data" == "null" ]]; then
        echo -e "${RED}é”™è¯¯: åˆ†ç»„ä¸å­˜åœ¨${RESET}"
        echo
        echo -e "${YELLOW}æç¤º: è¯·å…ˆè¿è¡Œ ${WHITE}yc providers${YELLOW} æŸ¥çœ‹å¯ç”¨çš„åˆ†ç»„ ID${RESET}"
        return 1
    fi

    local provider_id=$(echo "$selection_data" | jq -r '.provider_id')
    local selected_alt_id=$(echo "$selection_data" | jq -r '.selected_alternative_id')
    local selected_alt=$(echo "$selection_data" | jq -r '.selected_alternative')

    local display_name=$(echo "$selected_alt" | jq -r '.display_name')
    local type=$(echo "$selected_alt" | jq -r '.type')
    local rate=$(echo "$selected_alt" | jq -r '.rate_multiplier')
    local description=$(echo "$selected_alt" | jq -r '.description')

    # ä¼˜åŒ–è¾“å‡ºæ ¼å¼
    echo -e "åˆ†ç»„ ${BLUE}${provider_id}${RESET} å½“å‰ç”Ÿæ•ˆçš„æä¾›å•†ï¼š"
    echo -e "ID: ${BLUE}${selected_alt_id}${RESET} | ${GREEN}${BOLD}${display_name}${RESET} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET} | ç±»å‹: ${type}"
}

display_profile() {
    local data=$1

    # æå–ç”¨æˆ·èµ„æ–™ä¿¡æ¯
    local email=$(echo "$data" | jq -r '.email // "N/A"')
    local username=$(echo "$data" | jq -r '.username // "N/A"')

    # æå–ä½™é¢ä¿¡æ¯
    local balance=$(echo "$data" | jq -r '.balance // "0"')
    local subscription_balance=$(echo "$data" | jq -r '.subscription_balance // "0"')
    local payg_balance=$(echo "$data" | jq -r '.pay_as_you_go_balance // "0"')
    local balance_preference=$(echo "$data" | jq -r '.balance_preference // "N/A"')
    local subscription_expiry=$(echo "$data" | jq -r '.subscription_expiry // "N/A"')

    # æå–æ¶ˆè´¹ä¿¡æ¯
    local current_week_spend=$(echo "$data" | jq -r '.current_week_spend // "0"')
    local current_month_spend=$(echo "$data" | jq -r '.current_month_spend // "0"')

    # æå–è®¢é˜…å¥—é¤ä¿¡æ¯
    local plan_name=$(echo "$data" | jq -r '.subscription_plan.name // "N/A"')
    local plan_price=$(echo "$data" | jq -r '.subscription_plan.price // "0"')
    local plan_is_active=$(echo "$data" | jq -r '.subscription_plan.is_active // "false"')
    local plan_daily_balance=$(echo "$data" | jq -r '.subscription_plan.daily_balance // "0"')
    local plan_weekly_limit=$(echo "$data" | jq -r '.subscription_plan.weekly_limit // "0"')
    local plan_monthly_limit=$(echo "$data" | jq -r '.subscription_plan.monthly_spend_limit // "0"')

    # æ˜¾ç¤ºç”¨æˆ·èµ„æ–™
    echo -e "${CYAN}${BOLD}ğŸ‘¤ ç”¨æˆ·èµ„æ–™${RESET}"
    if [[ "$username" != "N/A" ]]; then
        echo -e "ç”¨æˆ·åï¼š${WHITE}${BOLD}${username}${RESET}"
    fi

    if [[ "$email" != "N/A" ]]; then
        echo -e "é‚®ç®±ï¼š${WHITE}${email}${RESET}"
    fi

    # æ˜¾ç¤ºä½™é¢ä¿¡æ¯
    echo
    echo -e "${CYAN}${BOLD}ğŸ’° ä½™é¢ä¿¡æ¯${RESET}"

    if [[ "$subscription_balance" != "0" && "$subscription_balance" != "N/A" ]]; then
        local color=$(get_balance_color "$subscription_balance")
        echo -e "è®¢é˜…ä½™é¢ï¼š${color}\$$(printf "%.2f" $subscription_balance)${RESET}"
    fi

    if [[ "$payg_balance" != "0" && "$payg_balance" != "N/A" ]]; then
        local color=$(get_balance_color "$payg_balance")
        echo -e "æŒ‰éœ€ä»˜è´¹ä½™é¢ï¼š${color}\$$(printf "%.2f" $payg_balance)${RESET}"
    fi

    if [[ "$balance" != "0" && "$balance" != "N/A" ]]; then
        local color=$(get_balance_color "$balance")
        echo -e "æ€»ä½™é¢ï¼š${color}\$$(printf "%.2f" $balance)${RESET}"
    fi

    # æ˜¾ç¤ºä½™é¢ä½¿ç”¨åå¥½
    if [[ "$balance_preference" != "N/A" ]]; then
        local preference_text=""
        if [[ "$balance_preference" == "subscription_first" ]]; then
            preference_text="${CYAN}ä¼˜å…ˆè®¢é˜…${RESET}"
        elif [[ "$balance_preference" == "payg_only" ]]; then
            preference_text="${YELLOW}ä»…æŒ‰éœ€ä»˜è´¹${RESET}"
        else
            preference_text="${WHITE}${balance_preference}${RESET}"
        fi
        echo -e "ä½™é¢ä½¿ç”¨åå¥½ï¼š${preference_text}"
    fi

    # æ˜¾ç¤ºè®¢é˜…å¥—é¤ä¿¡æ¯
    if [[ "$plan_name" != "N/A" ]]; then
        echo
        echo -e "${CYAN}${BOLD}ğŸ“¦ è®¢é˜…å¥—é¤${RESET}"

        echo -e "å¥—é¤åç§°ï¼š${WHITE}${BOLD}${plan_name}${RESET}"

        if [[ "$plan_price" != "0" && "$plan_price" != "N/A" ]]; then
            echo -e "å¥—é¤ä»·æ ¼ï¼š${GREEN}\$$(printf "%.2f" $plan_price)${RESET}"
        fi

        if [[ "$plan_is_active" == "true" ]]; then
            echo -e "å¥—é¤çŠ¶æ€ï¼š${GREEN}${BOLD}æœ‰æ•ˆ${RESET}"
        else
            echo -e "å¥—é¤çŠ¶æ€ï¼š${RED}æ— æ•ˆ${RESET}"
        fi

        # è®¢é˜…åˆ°æœŸæ—¶é—´ï¼ˆäººç±»æ˜“è¯»ï¼‰
        if [[ "$subscription_expiry" != "N/A" && "$subscription_expiry" != "null" ]]; then
            # å°è¯•è½¬æ¢ä¸ºäººç±»æ˜“è¯»æ ¼å¼
            local expiry_readable=""
            if command -v date &> /dev/null; then
                expiry_readable=$(date -d "$subscription_expiry" "+%Yå¹´%mæœˆ%dæ—¥ %H:%M" 2>/dev/null || echo "$subscription_expiry")
            else
                expiry_readable="$subscription_expiry"
            fi
            echo -e "è®¢é˜…åˆ°æœŸæ—¶é—´ï¼š${YELLOW}${expiry_readable}${RESET}"
        fi

        if [[ "$plan_daily_balance" != "0" && "$plan_daily_balance" != "N/A" ]]; then
            echo -e "æ—¥æ¶ˆè´¹é™é¢ï¼š${CYAN}\$$(printf "%.2f" $plan_daily_balance)${RESET}"
        fi

        # å‘¨æ¶ˆè´¹é™é¢ï¼ˆæ•´åˆå·²æ¶ˆè´¹å’Œç™¾åˆ†æ¯”ï¼‰
        if [[ "$plan_weekly_limit" != "0" && "$plan_weekly_limit" != "N/A" ]]; then
            local output="å‘¨æ¶ˆè´¹é™é¢ï¼š${CYAN}\$$(printf "%.2f" $plan_weekly_limit)${RESET}"

            if [[ "$current_week_spend" != "0" && "$current_week_spend" != "N/A" ]]; then
                local week_percent=$(echo "scale=10; ($current_week_spend / $plan_weekly_limit) * 100" | bc)
                local week_percent_formatted=$(printf "%.2f" $week_percent)
                local week_color=$(get_spending_color "$week_percent")
                output="${output} ${MAGENTA}(å·²æ¶ˆè´¹\$$(printf "%.2f" $current_week_spend), ${week_color}${week_percent_formatted}%${RESET}${MAGENTA})${RESET}"
            fi
            echo -e "$output"
        fi

        # æœˆæ¶ˆè´¹é™é¢ï¼ˆæ•´åˆå·²æ¶ˆè´¹å’Œç™¾åˆ†æ¯”ï¼‰
        if [[ "$plan_monthly_limit" != "0" && "$plan_monthly_limit" != "N/A" ]]; then
            local output="æœˆæ¶ˆè´¹é™é¢ï¼š${CYAN}\$$(printf "%.2f" $plan_monthly_limit)${RESET}"

            if [[ "$current_month_spend" != "0" && "$current_month_spend" != "N/A" ]]; then
                local month_percent=$(echo "scale=10; ($current_month_spend / $plan_monthly_limit) * 100" | bc)
                local month_percent_formatted=$(printf "%.2f" $month_percent)
                local month_color=$(get_spending_color "$month_percent")
                output="${output} ${MAGENTA}(å·²æ¶ˆè´¹\$$(printf "%.2f" $current_month_spend), ${month_color}${month_percent_formatted}%${RESET}${MAGENTA})${RESET}"
            fi
            echo -e "$output"
        fi
    fi
}

# ============================================================
# äº¤äº’å¼é€‰æ‹©å‡½æ•°
# ============================================================

interactive_select_provider() {
    local providers_data=$1

    echo -e "${CYAN}${BOLD}ğŸ“‹ é€‰æ‹©è¦åˆ‡æ¢æä¾›å•†çš„åˆ†ç»„ï¼š${RESET}" >&2
    echo >&2

    # è§£æå¹¶æ˜¾ç¤ºåˆ†ç»„åˆ—è¡¨
    local providers_count=$(echo "$providers_data" | jq '.providers | length')

    if [[ "$providers_count" == "0" ]]; then
        echo -e "${RED}é”™è¯¯: æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„${RESET}" >&2
        return 1
    fi

    # åˆ›å»ºåºå·æ•°ç»„å’ŒIDæ˜ å°„
    declare -a provider_ids
    declare -a provider_names

    for ((i=0; i<$providers_count; i++)); do
        local provider_data=$(echo "$providers_data" | jq -r ".providers[$i]")
        local provider_id=$(echo "$provider_data" | jq -r '.provider.id')
        local display_name=$(echo "$provider_data" | jq -r '.provider.display_name')
        local rate=$(echo "$provider_data" | jq -r '.rate_multiplier')
        local source=$(echo "$provider_data" | jq -r '.source')

        provider_ids[$i]=$provider_id
        provider_names[$i]=$display_name

        # è½¬æ¢ source ä¸ºä¸­æ–‡
        local source_text=""
        if [[ "$source" == "subscription" ]]; then
            source_text="${CYAN}è®¢é˜…${RESET}"
        else
            source_text="${YELLOW}æŒ‰éœ€${RESET}"
        fi

        # æ„å»ºæ˜¾ç¤ºè¡Œ
        local display_line="  ${WHITE}${BOLD}[$((i+1))]${RESET} ${display_name} | ID: ${BLUE}${provider_id}${RESET}"

        # æŒ‰éœ€ä»˜è´¹æ˜¾ç¤ºè´¹ç‡
        if [[ "$source" == "pay_as_you_go" ]]; then
            display_line="${display_line} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET}"
        fi

        display_line="${display_line} | æ¥æº: ${source_text}"

        echo -e "$display_line" >&2
    done

    echo >&2

    # è·å–ç”¨æˆ·è¾“å…¥
    while true; do
        read -p "è¯·è¾“å…¥åˆ†ç»„åºå· [1-$providers_count] (è¾“å…¥ q é€€å‡º): " choice

        # æ”¯æŒé€€å‡º
        if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
            return 1
        fi

        # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„åºå·${RESET}" >&2
            continue
        fi

        # éªŒè¯èŒƒå›´
        if [[ "$choice" -lt 1 || "$choice" -gt "$providers_count" ]]; then
            echo -e "${RED}é”™è¯¯: åºå·è¶…å‡ºèŒƒå›´ï¼Œè¯·è¾“å…¥ 1-$providers_count${RESET}" >&2
            continue
        fi

        # è¿”å›é€‰ä¸­çš„ provider_id å’Œåç§°ï¼Œç”¨ | åˆ†éš”
        local selected_index=$((choice - 1))
        echo "${provider_ids[$selected_index]}|${provider_names[$selected_index]}"
        return 0
    done
}

interactive_select_alternative() {
    local provider_id=$1
    local alternatives_data=$2
    local current_selection=$3
    local provider_name=$4

    echo >&2
    echo -e "${CYAN}${BOLD}ğŸ“‹ ${provider_name} åˆ†ç»„çš„å¯é€‰æä¾›å•†ï¼š${RESET}" >&2
    echo >&2

    # è§£ææ–¹æ¡ˆæ•°æ®
    local data_count=$(echo "$alternatives_data" | jq '.data | length')

    if [[ "$data_count" == "0" || "$data_count" == "null" ]]; then
        echo -e "${RED}é”™è¯¯: æ²¡æœ‰å¯ç”¨çš„æä¾›å•†${RESET}" >&2
        return 1
    fi

    # æå–å½“å‰é€‰æ‹©çš„æ–¹æ¡ˆID
    local current_alt_id=$(echo "$current_selection" | jq -r '.data.selected_alternative_id')

    # åˆ›å»ºæ–¹æ¡ˆæ•°ç»„
    declare -a alternative_ids
    declare -a alternative_names

    for ((i=0; i<$data_count; i++)); do
        local item=$(echo "$alternatives_data" | jq -r ".data[$i]")
        local alt_id=$(echo "$item" | jq -r '.alternative.id')
        local display_name=$(echo "$item" | jq -r '.alternative.display_name')
        local rate=$(echo "$item" | jq -r '.alternative.rate_multiplier')
        local is_self=$(echo "$item" | jq -r '.is_self')

        alternative_ids[$i]=$alt_id
        alternative_names[$i]=$display_name

        # åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ–¹æ¡ˆæˆ–å®˜æ–¹æ–¹æ¡ˆ
        local prefix_mark=""
        local suffix_mark=""

        if [[ "$alt_id" == "$current_alt_id" ]]; then
            prefix_mark="${GREEN}${BOLD}[å½“å‰]${RESET} "
        fi

        if [[ "$is_self" == "true" ]]; then
            suffix_mark=" ${YELLOW}(å®˜æ–¹)${RESET}"
        fi

        # æ˜¾ç¤ºé€‰é¡¹
        echo -e "  ${WHITE}${BOLD}[$((i+1))]${RESET} ${prefix_mark}${display_name}${suffix_mark} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET}" >&2
    done

    echo >&2

    # è·å–ç”¨æˆ·è¾“å…¥
    while true; do
        read -p "è¯·è¾“å…¥è¦åˆ‡æ¢åˆ°çš„æ–¹æ¡ˆåºå· [1-$data_count] (è¾“å…¥ q é€€å‡º): " choice

        # æ”¯æŒé€€å‡º
        if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
            return 1
        fi

        # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„åºå·${RESET}" >&2
            continue
        fi

        # éªŒè¯èŒƒå›´
        if [[ "$choice" -lt 1 || "$choice" -gt "$data_count" ]]; then
            echo -e "${RED}é”™è¯¯: åºå·è¶…å‡ºèŒƒå›´ï¼Œè¯·è¾“å…¥ 1-$data_count${RESET}" >&2
            continue
        fi

        # è¿”å›é€‰ä¸­çš„ alternative_id
        local selected_index=$((choice - 1))
        local selected_id="${alternative_ids[$selected_index]}"

        # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å½“å‰æ–¹æ¡ˆ
        if [[ "$selected_id" == "$current_alt_id" ]]; then
            echo -e "${YELLOW}âš  å·²ç»æ˜¯å½“å‰æ–¹æ¡ˆï¼Œæ— éœ€åˆ‡æ¢${RESET}" >&2
            return 1
        fi

        # ç›´æ¥è¿”å›é€‰ä¸­çš„æ–¹æ¡ˆ ID
        echo "$selected_id"
        return 0
    done
}

# ============================================================
# å‘½ä»¤å¤„ç†
# ============================================================

cmd_balance() {
    local balance_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨ï¼ˆä¸é‡å®šå‘ stderrï¼Œè®© verbose è¾“å‡ºç›´æ¥æ˜¾ç¤ºï¼‰
    (api_get_balance > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    balance_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$balance_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆè®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_get_balance > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        balance_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$balance_data" && "$balance_data" != "AUTH_ERROR_401" ]]; then
        echo
        display_balance_info "$balance_data"
        echo
    else
        echo -e "${RED}âœ— è·å–ä½™é¢å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_profile() {
    local profile_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨
    (api_get_profile > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    profile_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$profile_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆè®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_get_profile > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        profile_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$profile_data" && "$profile_data" != "AUTH_ERROR_401" ]]; then
        echo
        display_profile "$profile_data"
        echo
    else
        echo -e "${RED}âœ— è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_providers() {
    local providers_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨
    (api_get_providers > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    providers_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$providers_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_get_providers > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        providers_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$providers_data" && "$providers_data" != "AUTH_ERROR_401" ]]; then
        echo
        display_providers_info "$providers_data"
        echo
    else
        echo -e "${RED}âœ— è·å–åˆ†ç»„ä¿¡æ¯å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_provider_alternatives() {
    local provider_id=$1

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾› provider_id${RESET}"
        echo "ç”¨æ³•: yc provider-alternatives <provider_id>"
        exit 1
    fi

    local alternatives_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨
    (api_get_provider_alternatives "$provider_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    alternatives_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$alternatives_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_get_provider_alternatives "$provider_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        alternatives_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$alternatives_data" && "$alternatives_data" != "AUTH_ERROR_401" ]]; then
        echo
        display_provider_alternatives "$alternatives_data" "$provider_id"
        echo
    else
        echo -e "${RED}âœ— è·å–å¯ç”¨æä¾›å•†å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_provider_selection() {
    local provider_id=$1

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾› provider_id${RESET}"
        echo "ç”¨æ³•: yc provider-selection <provider_id>"
        exit 1
    fi

    local selection_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨
    (api_get_provider_selection "$provider_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    selection_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$selection_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_get_provider_selection "$provider_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        selection_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$selection_data" && "$selection_data" != "AUTH_ERROR_401" ]]; then
        echo
        display_provider_selection "$selection_data"
        echo
    else
        echo -e "${RED}âœ— è·å–å½“å‰ç”Ÿæ•ˆçš„æä¾›å•†å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_set_provider_selection() {
    local provider_id=$1
    local selected_alternative_id=$2

    if [[ -z "$provider_id" ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾› provider_id${RESET}"
        echo "ç”¨æ³•: yc set-provider-selection <provider_id> <alternative_id>"
        exit 1
    fi

    if [[ -z "$selected_alternative_id" ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾› alternative_id${RESET}"
        echo "ç”¨æ³•: yc set-provider-selection <provider_id> <alternative_id>"
        exit 1
    fi

    local result_data
    local exit_code
    local temp_file=$(mktemp)

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e

    # åœ¨åå°æ‰§è¡Œ API è°ƒç”¨
    (api_set_provider_selection "$provider_id" "$selected_alternative_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $api_pid

    # ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ
    wait $api_pid

    # è¯»å–ç»“æœ
    result_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file" "${temp_file}.exit"

    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$result_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚ï¼ˆå¸¦loadingï¼‰
        set +e
        temp_file=$(mktemp)
        (api_set_provider_selection "$provider_id" "$selected_alternative_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        result_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$result_data" && "$result_data" != "AUTH_ERROR_401" ]]; then
        echo

        # æå–å¹¶æ˜¾ç¤ºé€‰æ‹©ä¿¡æ¯
        local selected_alt=$(echo "$result_data" | jq -r '.data.selected_alternative')
        local display_name=$(echo "$selected_alt" | jq -r '.display_name')
        local alt_id=$(echo "$selected_alt" | jq -r '.id')
        local type=$(echo "$selected_alt" | jq -r '.type')
        local rate=$(echo "$selected_alt" | jq -r '.rate_multiplier')

        echo -e "åˆ†ç»„ ${BLUE}${provider_id}${RESET} æä¾›å•†å·²åˆ‡æ¢ä¸ºï¼š${WHITE}${BOLD}${display_name}${RESET}"
        echo -e "ID: ${BLUE}${alt_id}${RESET} | ç±»å‹: ${type} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET}"
        echo
    else
        echo -e "${RED}âœ— æä¾›å•†è®¾ç½®å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_switch() {
    local provider_id=$1
    local provider_name=""
    local providers_data
    local alternatives_data
    local current_selection
    local exit_code
    local temp_file

    # å¦‚æœæ²¡æœ‰æä¾› provider_idï¼Œåˆ™è¿›å…¥äº¤äº’å¼é€‰æ‹©
    if [[ -z "$provider_id" ]]; then
        # è·å–æ‰€æœ‰åˆ†ç»„
        temp_file=$(mktemp)
        set +e
        (api_get_providers > "$temp_file"; echo $? > "${temp_file}.exit") &
        local api_pid=$!
        show_loading $api_pid
        wait $api_pid
        providers_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e

        # å¤„ç†è®¤è¯é”™è¯¯
        if [[ $exit_code -eq 2 && "$providers_data" == "AUTH_ERROR_401" ]]; then
            echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
            prompt_api_key false
            load_config

            # é‡è¯•
            temp_file=$(mktemp)
            set +e
            (api_get_providers > "$temp_file"; echo $? > "${temp_file}.exit") &
            api_pid=$!
            show_loading $api_pid
            wait $api_pid
            providers_data=$(cat "$temp_file")
            exit_code=$(cat "${temp_file}.exit")
            rm -f "$temp_file" "${temp_file}.exit"
            set -e
        fi

        if [[ $exit_code -ne 0 || -z "$providers_data" || "$providers_data" == "AUTH_ERROR_401" ]]; then
            echo -e "${RED}âœ— è·å–åˆ†ç»„åˆ—è¡¨å¤±è´¥${RESET}"
            exit 1
        fi

        echo
        # äº¤äº’å¼é€‰æ‹©åˆ†ç»„ï¼ˆè¿”å›æ ¼å¼: id|nameï¼‰
        local selection_result
        selection_result=$(interactive_select_provider "$providers_data")
        if [[ $? -ne 0 || -z "$selection_result" ]]; then
            echo
            echo -e "${YELLOW}å·²å–æ¶ˆæ“ä½œ${RESET}"
            exit 0
        fi

        # æ‹†åˆ† id å’Œ name
        provider_id=$(echo "$selection_result" | cut -d'|' -f1)
        provider_name=$(echo "$selection_result" | cut -d'|' -f2)
    else
        # å¦‚æœç›´æ¥æŒ‡å®šäº† provider_idï¼Œéœ€è¦æŸ¥è¯¢åˆ†ç»„åç§°
        temp_file=$(mktemp)
        set +e
        (api_get_providers > "$temp_file"; echo $? > "${temp_file}.exit") &
        local api_pid=$!
        show_loading $api_pid
        wait $api_pid
        providers_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e

        if [[ $exit_code -eq 0 && -n "$providers_data" ]]; then
            # ä» providers_data ä¸­æŸ¥æ‰¾åˆ†ç»„åç§°
            provider_name=$(echo "$providers_data" | jq -r ".providers[] | select(.provider.id == $provider_id) | .provider.display_name")
            if [[ -z "$provider_name" || "$provider_name" == "null" ]]; then
                provider_name="åˆ†ç»„ ${provider_id}"
            fi
        else
            provider_name="åˆ†ç»„ ${provider_id}"
        fi
    fi

    # å¹¶è¡Œè·å–å¯ç”¨æ–¹æ¡ˆå’Œå½“å‰é€‰æ‹©
    local temp_alternatives=$(mktemp)
    local temp_selection=$(mktemp)

    set +e
    (api_get_provider_alternatives "$provider_id" > "$temp_alternatives"; echo $? > "${temp_alternatives}.exit") &
    local pid_alternatives=$!
    (api_get_provider_selection "$provider_id" > "$temp_selection"; echo $? > "${temp_selection}.exit") &
    local pid_selection=$!

    # æ˜¾ç¤º loading åŠ¨ç”»
    show_loading $pid_alternatives

    # ç­‰å¾…ä¸¤ä¸ª API è°ƒç”¨å®Œæˆ
    wait $pid_alternatives
    wait $pid_selection

    alternatives_data=$(cat "$temp_alternatives")
    local exit_code_alt=$(cat "${temp_alternatives}.exit")
    current_selection=$(cat "$temp_selection")
    local exit_code_sel=$(cat "${temp_selection}.exit")

    rm -f "$temp_alternatives" "${temp_alternatives}.exit" "$temp_selection" "${temp_selection}.exit"
    set -e

    # æ£€æŸ¥ç»“æœ
    if [[ $exit_code_alt -ne 0 || $exit_code_sel -ne 0 ]]; then
        echo -e "${RED}âœ— è·å–æ–¹æ¡ˆä¿¡æ¯å¤±è´¥${RESET}"
        echo -e "${YELLOW}æç¤º: è¯·æ£€æŸ¥ provider_id æ˜¯å¦æ­£ç¡®${RESET}"
        exit 1
    fi

    # äº¤äº’å¼é€‰æ‹©æ–¹æ¡ˆ
    local selected_alt_id
    selected_alt_id=$(interactive_select_alternative "$provider_id" "$alternatives_data" "$current_selection" "$provider_name")
    if [[ $? -ne 0 || -z "$selected_alt_id" ]]; then
        echo
        exit 0
    fi

    # æ‰§è¡Œåˆ‡æ¢
    echo
    local result_data
    temp_file=$(mktemp)
    set +e
    (api_set_provider_selection "$provider_id" "$selected_alt_id" > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!
    show_loading $api_pid
    wait $api_pid
    result_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")
    rm -f "$temp_file" "${temp_file}.exit"
    set -e

    # æ£€æŸ¥åˆ‡æ¢ç»“æœ
    if [[ $exit_code -eq 0 && -n "$result_data" && "$result_data" != "AUTH_ERROR_401" ]]; then
        echo
        local selected_alt=$(echo "$result_data" | jq -r '.data.selected_alternative')
        local display_name=$(echo "$selected_alt" | jq -r '.display_name')
        local rate=$(echo "$selected_alt" | jq -r '.rate_multiplier')

        echo -e "${GREEN}${BOLD}âœ“ åˆ‡æ¢æˆåŠŸï¼${RESET}"
        echo
        echo -e "${provider_name} çš„æä¾›å•†å·²åˆ‡æ¢ä¸ºï¼š"
        echo -e "${WHITE}${BOLD}${display_name}${RESET} | è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET}"
        echo
    else
        echo -e "${RED}âœ— åˆ‡æ¢å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_balance_preference() {
    local preference=$1

    # å¦‚æœæ²¡æœ‰æä¾›å‚æ•°ï¼Œåˆ™è¿›å…¥äº¤äº’å¼é€‰æ‹©
    if [[ -z "$preference" ]]; then
        # è·å–å½“å‰ä½™é¢åå¥½è®¾ç½®
        local profile_data
        local exit_code
        local temp_file=$(mktemp)

        set +e
        (api_get_profile > "$temp_file"; echo $? > "${temp_file}.exit") &
        local api_pid=$!
        show_loading $api_pid
        wait $api_pid
        profile_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e

        # å¤„ç†è®¤è¯é”™è¯¯
        if [[ $exit_code -eq 2 && "$profile_data" == "AUTH_ERROR_401" ]]; then
            echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆè®¤è¯å¤±è´¥ï¼‰${RESET}"
            prompt_api_key false
            load_config

            # é‡è¯•
            temp_file=$(mktemp)
            set +e
            (api_get_profile > "$temp_file"; echo $? > "${temp_file}.exit") &
            api_pid=$!
            show_loading $api_pid
            wait $api_pid
            profile_data=$(cat "$temp_file")
            exit_code=$(cat "${temp_file}.exit")
            rm -f "$temp_file" "${temp_file}.exit"
            set -e
        fi

        # æå–å½“å‰ä½™é¢åå¥½
        local current_preference="N/A"
        if [[ $exit_code -eq 0 && -n "$profile_data" && "$profile_data" != "AUTH_ERROR_401" ]]; then
            current_preference=$(echo "$profile_data" | jq -r '.balance_preference // "N/A"')
        fi

        echo
        echo -e "${CYAN}${BOLD}ğŸ’³ é€‰æ‹©ä½™é¢ä½¿ç”¨åå¥½ï¼š${RESET}"
        echo

        # æ˜¾ç¤ºé€‰é¡¹1ï¼ˆä¼˜å…ˆè®¢é˜…ï¼‰
        local option1_prefix=""
        if [[ "$current_preference" == "subscription_first" ]]; then
            option1_prefix="${GREEN}${BOLD}[å½“å‰]${RESET} "
        fi
        echo -e "  ${WHITE}${BOLD}[1]${RESET} ${option1_prefix}ä¼˜å…ˆè®¢é˜… (subscription_first)"
        echo -e "      ${WHITE}å…ˆä½¿ç”¨è®¢é˜…ä½™é¢ï¼Œç„¶åä½¿ç”¨æŒ‰éœ€ä»˜è´¹${RESET}"
        echo -e "      ${YELLOW}âš  OPUSä½¿ç”¨é™åˆ¶é€‚ç”¨${RESET}"
        echo

        # æ˜¾ç¤ºé€‰é¡¹2ï¼ˆä»…æŒ‰éœ€ä»˜è´¹ï¼‰
        local option2_prefix=""
        if [[ "$current_preference" == "payg_only" ]]; then
            option2_prefix="${GREEN}${BOLD}[å½“å‰]${RESET} "
        fi
        echo -e "  ${WHITE}${BOLD}[2]${RESET} ${option2_prefix}ä»…æŒ‰éœ€ä»˜è´¹ (payg_only)"
        echo -e "      ${WHITE}å§‹ç»ˆä½¿ç”¨æŒ‰éœ€ä»˜è´¹ä½™é¢${RESET}"
        echo -e "      ${GREEN}âœ“ æ— OPUSä½¿ç”¨é™åˆ¶${RESET}"
        echo

        # è·å–ç”¨æˆ·è¾“å…¥
        while true; do
            read -p "è¯·è¾“å…¥é€‰é¡¹ [1-2] (è¾“å…¥ q é€€å‡º): " choice

            # æ”¯æŒé€€å‡º
            if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
                echo -e "${YELLOW}å·²å–æ¶ˆæ“ä½œ${RESET}"
                exit 0
            fi

            # éªŒè¯è¾“å…¥
            case "$choice" in
                1)
                    preference="subscription_first"
                    break
                    ;;
                2)
                    preference="payg_only"
                    break
                    ;;
                *)
                    echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1 æˆ– 2${RESET}"
                    continue
                    ;;
            esac
        done

        # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å½“å‰é€‰é¡¹
        if [[ "$preference" == "$current_preference" ]]; then
            echo -e "${YELLOW}âš  å·²ç»æ˜¯å½“å‰è®¾ç½®ï¼Œæ— éœ€åˆ‡æ¢${RESET}"
            exit 0
        fi
    else
        # éªŒè¯ç›´æ¥æä¾›çš„å‚æ•°
        if [[ "$preference" != "subscription_first" && "$preference" != "payg_only" ]]; then
            echo -e "${RED}é”™è¯¯: preference å¿…é¡»æ˜¯ 'subscription_first' æˆ– 'payg_only'${RESET}"
            echo "ç”¨æ³•: yc balance-preference [subscription_first|payg_only]"
            exit 1
        fi
    fi

    # æ‰§è¡Œè®¾ç½®
    local result_data
    local exit_code
    local temp_file=$(mktemp)

    set +e
    (api_set_balance_preference "$preference" > "$temp_file"; echo $? > "${temp_file}.exit") &
    local api_pid=$!
    show_loading $api_pid
    wait $api_pid
    result_data=$(cat "$temp_file")
    exit_code=$(cat "${temp_file}.exit")
    rm -f "$temp_file" "${temp_file}.exit"
    set -e

    # å¤„ç†è®¤è¯é”™è¯¯
    if [[ $exit_code -eq 2 && "$result_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false
        load_config

        # é‡è¯•
        temp_file=$(mktemp)
        set +e
        (api_set_balance_preference "$preference" > "$temp_file"; echo $? > "${temp_file}.exit") &
        api_pid=$!
        show_loading $api_pid
        wait $api_pid
        result_data=$(cat "$temp_file")
        exit_code=$(cat "${temp_file}.exit")
        rm -f "$temp_file" "${temp_file}.exit"
        set -e
    fi

    # æ£€æŸ¥è®¾ç½®ç»“æœ
    if [[ $exit_code -eq 0 && -n "$result_data" && "$result_data" != "AUTH_ERROR_401" ]]; then
        echo
        echo -e "${GREEN}${BOLD}âœ“ ä½™é¢ä½¿ç”¨åå¥½è®¾ç½®æˆåŠŸï¼${RESET}"
        echo

        # æ˜¾ç¤ºè®¾ç½®çš„åå¥½
        local preference_text=""
        local preference_desc=""
        if [[ "$preference" == "subscription_first" ]]; then
            preference_text="${CYAN}ä¼˜å…ˆè®¢é˜…${RESET}"
            preference_desc="å…ˆä½¿ç”¨è®¢é˜…ä½™é¢ï¼Œç„¶åä½¿ç”¨æŒ‰éœ€ä»˜è´¹ ${YELLOW}(OPUSä½¿ç”¨é™åˆ¶é€‚ç”¨)${RESET}"
        else
            preference_text="${YELLOW}ä»…æŒ‰éœ€ä»˜è´¹${RESET}"
            preference_desc="å§‹ç»ˆä½¿ç”¨æŒ‰éœ€ä»˜è´¹ä½™é¢ ${GREEN}(æ— OPUSä½¿ç”¨é™åˆ¶)${RESET}"
        fi

        echo -e "å½“å‰ä½™é¢ä½¿ç”¨åå¥½ï¼š${WHITE}${BOLD}${preference_text}${RESET}"
        echo -e "${preference_desc}"
        echo
    else
        echo -e "${RED}âœ— è®¾ç½®ä½™é¢ä½¿ç”¨åå¥½å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_uninstall() {
    # æ£€æµ‹æ˜¯å¦ä»é¡¹ç›®ç›®å½•è¿è¡Œï¼ˆ./yc æˆ–ç›¸å¯¹è·¯å¾„ï¼‰
    if [[ "$0" == ./* || "$0" == */* ]] && command -v yc &> /dev/null; then
        # ä»é¡¹ç›®ç›®å½•è¿è¡Œï¼Œä½†ç³»ç»Ÿä¸­æœ‰å®‰è£…çš„ yc å‘½ä»¤
        local installed_yc=$(which yc 2>/dev/null)
        local current_script=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")

        # å¦‚æœä¸¤è€…ä¸åŒï¼Œè¯´æ˜ç”¨æˆ·åœ¨é¡¹ç›®ç›®å½•è¿è¡Œï¼Œä½†ç³»ç»Ÿæœ‰å®‰è£…çš„ç‰ˆæœ¬
        if [[ "$installed_yc" != "$current_script" ]]; then
            echo -e "${YELLOW}æ£€æµ‹åˆ°æ‚¨æ­£åœ¨é¡¹ç›®ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬${RESET}"
            echo -e "è¦å¸è½½ç³»ç»Ÿå®‰è£…çš„ yc å‘½ä»¤ï¼Œè¯·ç›´æ¥è¿è¡Œï¼š"
            echo -e "  ${WHITE}${BOLD}yc uninstall${RESET}"
            echo
            echo -e "ç³»ç»Ÿå®‰è£…è·¯å¾„: ${CYAN}$installed_yc${RESET}"
            echo -e "å½“å‰è„šæœ¬è·¯å¾„: ${CYAN}$current_script${RESET}"
            exit 1
        fi
    fi

    # è·å– yc å‘½ä»¤çš„å®é™…è·¯å¾„
    local yc_path=""

    # ä¼˜å…ˆæŸ¥æ‰¾ç³»ç»Ÿå®‰è£…çš„ yc å‘½ä»¤
    if command -v yc &> /dev/null; then
        yc_path=$(which yc)
    fi

    # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨å½“å‰è„šæœ¬è·¯å¾„
    if [[ -z "$yc_path" ]]; then
        yc_path=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™åˆ é™¤
    if [[ ! -w "$yc_path" && ! -w "$(dirname "$yc_path")" ]]; then
        echo -e "${RED}âœ— æ²¡æœ‰æƒé™åˆ é™¤ $yc_path${RESET}"
        echo "è¯·ä½¿ç”¨ sudo è¿è¡Œæˆ–æ‰‹åŠ¨åˆ é™¤"
        exit 1
    fi

    # è¯¢é—®æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶
    local delete_config=false
    if [[ -f "$HOME/.yescode/config.json" ]]; then
        read -p "æ˜¯å¦åŒæ—¶åˆ é™¤é…ç½®æ–‡ä»¶? (y/n): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            delete_config=true
        fi
    fi

    # åˆ é™¤ yc å‘½ä»¤
    if rm -f "$yc_path" 2>/dev/null; then
        echo -e "${GREEN}âœ“ å·²å¸è½½ yc${RESET}"
    else
        echo -e "${RED}âœ— å¸è½½å¤±è´¥${RESET}"
        exit 1
    fi

    # åˆ é™¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©ï¼‰
    if [[ "$delete_config" == true ]]; then
        rm -rf "$HOME/.yescode" 2>/dev/null
        echo -e "${GREEN}âœ“ å·²åˆ é™¤é…ç½®æ–‡ä»¶${RESET}"
    fi
}

cmd_install() {
    # æ£€æŸ¥ä¾èµ–
    local missing_deps=()

    if ! command -v curl &> /dev/null; then
        missing_deps+=("curl")
    fi

    if ! command -v jq &> /dev/null; then
        missing_deps+=("jq")
    fi

    # å¦‚æœæœ‰ç¼ºå¤±çš„ä¾èµ–ï¼Œå°è¯•è‡ªåŠ¨å®‰è£…
    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo -e "${YELLOW}âš  ç¼ºå°‘ä¾èµ–: ${missing_deps[*]}${RESET}"

        local pkg_manager=$(detect_package_manager)

        if [[ "$pkg_manager" != "unknown" ]]; then
            # å°è¯•è‡ªåŠ¨å®‰è£…æ¯ä¸ªç¼ºå¤±çš„ä¾èµ–
            for dep in "${missing_deps[@]}"; do
                if auto_install_dependency "$dep"; then
                    # å®‰è£…æˆåŠŸï¼Œä»ç¼ºå¤±åˆ—è¡¨ä¸­ç§»é™¤
                    missing_deps=("${missing_deps[@]/$dep}")
                fi
            done

            # è¿‡æ»¤ç©ºå…ƒç´ 
            missing_deps=($(printf '%s\n' "${missing_deps[@]}" | grep -v '^$'))
        fi

        # é‡æ–°æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç¼ºå¤±
        if [ ${#missing_deps[@]} -gt 0 ]; then
            echo
            echo -e "${YELLOW}âš  ä¾èµ–ä»ç„¶ç¼ºå¤±: ${missing_deps[*]}${RESET}"
            echo "è¯·æ‰‹åŠ¨å®‰è£…ï¼š"
            echo "  Ubuntu/Debian: sudo apt install ${missing_deps[*]}"
            echo "  RHEL/CentOS: sudo yum install ${missing_deps[*]}"
            echo "  Fedora: sudo dnf install ${missing_deps[*]}"
            echo "  macOS: brew install ${missing_deps[*]}"
            echo "  Arch Linux: sudo pacman -S ${missing_deps[*]}"
            echo
            read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/n): " -r
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "å·²å–æ¶ˆ"
                exit 1
            fi
        fi
    fi

    # è·å–å½“å‰è„šæœ¬è·¯å¾„
    local script_path=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")

    # ç¡®å®šå®‰è£…ç›®æ ‡ç›®å½•
    local install_dir=""
    if [ -w "/usr/local/bin" ]; then
        install_dir="/usr/local/bin"
    elif [ -d "$HOME/.local/bin" ]; then
        install_dir="$HOME/.local/bin"
    else
        install_dir="$HOME/.local/bin"
        mkdir -p "$install_dir"
    fi

    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    local install_path="$install_dir/yc"
    if [ -f "$install_path" ]; then
        if [ "$script_path" = "$install_path" ]; then
            echo -e "${CYAN}â„¹ yc å·²å®‰è£…${RESET}"
            return 0
        fi
    fi

    # å®‰è£…è„šæœ¬æ–‡ä»¶
    if cp "$script_path" "$install_path" 2>/dev/null; then
        chmod +x "$install_path"
        echo -e "${GREEN}âœ“ å·²å®‰è£…åˆ° $install_path${RESET}"
    else
        echo -e "${RED}âœ— å®‰è£…å¤±è´¥ï¼Œæ²¡æœ‰æƒé™å†™å…¥ $install_dir${RESET}"
        echo "è¯·ä½¿ç”¨ sudo è¿è¡Œ"
        exit 1
    fi

    # é…ç½® API Key
    local config_dir="$HOME/.yescode"
    local config_file="$config_dir/config.json"

    if [ ! -f "$config_file" ]; then
        mkdir -p "$config_dir"
        read -p "é…ç½® API Key: " api_key

        # éªŒè¯è¾“å…¥
        if [[ -z "$api_key" ]]; then
            echo -e "${RED}é”™è¯¯: API Key ä¸èƒ½ä¸ºç©º${RESET}"
            exit 1
        fi

        # ä¿å­˜é…ç½®
        echo "{\"api_key\": \"$api_key\"}" > "$config_file"
        chmod 600 "$config_file"

        echo -e "${GREEN}âœ“ é…ç½®å·²ä¿å­˜${RESET}"
    fi

    # æ£€æŸ¥ PATH
    if [[ ":$PATH:" != *":$install_dir:"* ]]; then
        echo
        echo -e "${YELLOW}âš  $install_dir ä¸åœ¨ PATH ä¸­${RESET}"
        echo "è¯·æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc:"
        echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi

    # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    echo
    show_help
}

show_help() {
    cat << EOF
usage: yc [-h] [-d] {balance,profile,providers,provider-alternatives,provider-selection,set-provider-selection,switch,balance-preference,install,uninstall}

YesCode API è°ƒç”¨å·¥å…· - æŸ¥è¯¢ä½™é¢ã€åˆ†ç»„ç­‰åŠŸèƒ½

positional arguments:
  balance                                æŸ¥è¯¢è´¦æˆ·ä½™é¢å’Œè®¢é˜…ä¿¡æ¯
  profile                                æŸ¥è¯¢ç”¨æˆ·èµ„æ–™ä¿¡æ¯
  providers                              æŸ¥è¯¢å¯ç”¨çš„ AI åˆ†ç»„
  provider-alternatives <id>             æŸ¥è¯¢æŒ‡å®šåˆ†ç»„æä¾›çš„æ‰€æœ‰å¯ç”¨æä¾›å•†
  provider-selection <id>                æŸ¥è¯¢æŒ‡å®šåˆ†ç»„å½“å‰ç”Ÿæ•ˆçš„æä¾›å•†
  set-provider-selection <id> <alt>      è®¾ç½®æŒ‡å®šåˆ†ç»„çš„ç”Ÿæ•ˆæä¾›å•†
  switch [id]                            äº¤äº’å¼åˆ‡æ¢æä¾›å•† (æ¨èä½¿ç”¨)
  balance-preference [preference]        è®¾ç½®ä½™é¢ä½¿ç”¨åå¥½ (æ¨èä½¿ç”¨)
                                         å‚æ•°: subscription_first | payg_only
  install                                å®‰è£… yc å‘½ä»¤åˆ°ç³»ç»Ÿ
  uninstall                              å¸è½½ yc å‘½ä»¤

options:
  -h, --help     æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -d, --debug    æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¯·æ±‚å¤´ã€å“åº”å¤´ã€å®Œæ•´ JSON ç­‰ï¼‰

ä½¿ç”¨ç¤ºä¾‹:
  yc balance                            # æŸ¥è¯¢ä½™é¢
  yc profile                            # æŸ¥è¯¢ç”¨æˆ·èµ„æ–™
  yc -d balance                         # æŸ¥è¯¢ä½™é¢ï¼ˆæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼‰
  yc --debug providers                  # æŸ¥è¯¢åˆ†ç»„ï¼ˆæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼‰
  yc provider-alternatives 5            # æŸ¥è¯¢åˆ†ç»„ 5 çš„æ‰€æœ‰å¯ç”¨æä¾›å•†
  yc provider-selection 5               # æŸ¥è¯¢åˆ†ç»„ 5 çš„å½“å‰æä¾›å•†
  yc set-provider-selection 5 12        # è®¾ç½®åˆ†ç»„ 5 çš„æä¾›å•†ä¸º 12
  yc switch                             # äº¤äº’å¼åˆ‡æ¢æä¾›å•†
  yc switch 5                           # åˆ‡æ¢åˆ†ç»„ 5 çš„æä¾›å•†
  yc balance-preference                 # äº¤äº’å¼é€‰æ‹©ä½™é¢ä½¿ç”¨åå¥½
  yc balance-preference subscription_first  # è®¾ç½®ä¸ºä¼˜å…ˆè®¢é˜…æ¨¡å¼
  yc balance-preference payg_only       # è®¾ç½®ä¸ºä»…æŒ‰éœ€ä»˜è´¹æ¨¡å¼
  yc install                            # å®‰è£… yc
  yc uninstall                          # å¸è½½ yc
  yc --help                             # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
EOF
}

# ============================================================
# ä¸»ç¨‹åº
# ============================================================

main() {
    # å…¨å±€ debug æ ‡å¿—
    DEBUG=false

    # è§£æå…¨å±€é€‰é¡¹
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -d|--debug)
                DEBUG=true
                shift
                ;;
            *)
                # é‡åˆ°éé€‰é¡¹å‚æ•°ï¼Œç»“æŸå¾ªç¯
                break
                ;;
        esac
    done

    # è§£æå‘½ä»¤è¡Œå‚æ•°
    if [[ $# -eq 0 ]]; then
        show_help
        exit 1
    fi

    # å¤„ç†ä¸éœ€è¦ä¾èµ–æ£€æŸ¥çš„å‘½ä»¤
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        install)
            cmd_install
            exit 0
            ;;
        uninstall)
            cmd_uninstall
            exit 0
            ;;
    esac

    # æ£€æŸ¥ä¾èµ–ï¼ˆbalance ç­‰å‘½ä»¤éœ€è¦ï¼‰
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° jq å‘½ä»¤${RESET}"
        echo "è¯·å®‰è£… jq: apt install jq (Ubuntu/Debian) æˆ– brew install jq (macOS)"
        exit 1
    fi

    if ! command -v curl &> /dev/null; then
        echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° curl å‘½ä»¤${RESET}"
        echo "è¯·å®‰è£… curl: apt install curl (Ubuntu/Debian) æˆ– brew install curl (macOS)"
        exit 1
    fi

    # å¤„ç†éœ€è¦ä¾èµ–çš„å‘½ä»¤
    case "$1" in
        balance)
            load_config
            cmd_balance
            ;;
        profile)
            load_config
            cmd_profile
            ;;
        providers)
            load_config
            cmd_providers
            ;;
        provider-alternatives)
            load_config
            cmd_provider_alternatives "$2"
            ;;
        provider-selection)
            load_config
            cmd_provider_selection "$2"
            ;;
        set-provider-selection)
            load_config
            cmd_set_provider_selection "$2" "$3"
            ;;
        switch)
            load_config
            cmd_switch "$2"
            ;;
        balance-preference)
            load_config
            cmd_balance_preference "$2"
            ;;
        *)
            echo -e "${RED}é”™è¯¯: æœªçŸ¥å‘½ä»¤ '$1'${RESET}"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"

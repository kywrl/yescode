#!/usr/bin/env bash
# YesCode CLI
# ä¾èµ–: curl, jq

set -e

# ============================================================
# é¢œè‰²å®šä¹‰
# ============================================================

# ANSI é¢œè‰²ç 
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
RESET='\033[0m'

# ============================================================
# é…ç½®ç®¡ç†
# ============================================================

prompt_api_key() {
    local show_message="${1:-true}"  # é»˜è®¤æ˜¾ç¤ºæç¤ºä¿¡æ¯
    local config_dir="$HOME/.yescode"
    local config_file="$config_dir/config.json"

    if [[ "$show_message" == "true" ]]; then
        echo
        echo -e "${YELLOW}æœªé…ç½® API Key${RESET}"
        echo
    fi

    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p "$config_dir"

    # æç¤ºç”¨æˆ·è¾“å…¥
    echo
    read -p "è¯·è¾“å…¥æ‚¨çš„ API Key: " api_key

    # éªŒè¯è¾“å…¥
    if [[ -z "$api_key" ]]; then
        echo -e "${RED}é”™è¯¯: API Key ä¸èƒ½ä¸ºç©º${RESET}"
        exit 1
    fi

    # ä¿å­˜é…ç½®
    echo "{\"api_key\": \"$api_key\"}" > "$config_file"
    chmod 600 "$config_file"

    echo -e "${GREEN}âœ“ é…ç½®å·²ä¿å­˜åˆ°: $config_file${RESET}"
    echo
}

load_config() {
    local config_file="$HOME/.yescode/config.json"

    # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
    if [[ ! -f "$config_file" ]]; then
        prompt_api_key
    fi

    # ä½¿ç”¨ jq è¯»å– API Key
    API_KEY=$(jq -r '.api_key' "$config_file" 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯${RESET}"
        echo "è¯·ç¡®ä¿ $config_file æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
        exit 1
    fi

    # å¦‚æœ API Key ä¸ºç©ºæˆ– nullï¼Œæç¤ºç”¨æˆ·è¾“å…¥
    if [[ -z "$API_KEY" || "$API_KEY" == "null" ]]; then
        prompt_api_key
        # é‡æ–°è¯»å–é…ç½®
        API_KEY=$(jq -r '.api_key' "$config_file" 2>/dev/null)
    fi

    # å›ºå®šçš„ API Base URL
    API_BASE_URL="https://co.yes.vg"
}

# ============================================================
# é¢œè‰²å·¥å…·å‡½æ•°
# ============================================================

get_balance_color() {
    local balance=$1
    local threshold_low=20
    local threshold_medium=50

    if (( $(echo "$balance < $threshold_low" | bc -l) )); then
        echo "$RED"
    elif (( $(echo "$balance < $threshold_medium" | bc -l) )); then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

get_spending_color() {
    local spent_percent=$1

    if (( $(echo "$spent_percent >= 95" | bc -l) )); then
        echo "$RED"
    elif (( $(echo "$spent_percent >= 80" | bc -l) )); then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

create_progress_bar() {
    local current=$1
    local total=$2
    local width=30

    if (( $(echo "$total == 0" | bc -l) )); then
        local percent=0
        local filled=0
    else
        local percent=$(echo "scale=1; ($current / $total) * 100" | bc)
        local filled=$(echo "scale=0; ($current / $total) * $width" | bc)
    fi

    local empty=$((width - filled))
    local bar=$(printf 'â–ˆ%.0s' $(seq 1 $filled))$(printf 'â–‘%.0s' $(seq 1 $empty))

    local color=$(get_spending_color "$percent")
    echo -e "[${color}${bar}${RESET}] ${color}${BOLD}${percent}%${RESET}"
}

# ============================================================
# ç³»ç»Ÿæ£€æµ‹ä¸ä¾èµ–å®‰è£…
# ============================================================

detect_package_manager() {
    # æ£€æµ‹ç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨å¹¶è¿”å›å®‰è£…å‘½ä»¤
    if command -v apt &> /dev/null; then
        echo "apt"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v yum &> /dev/null; then
        echo "yum"
    elif command -v brew &> /dev/null; then
        echo "brew"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v zypper &> /dev/null; then
        echo "zypper"
    else
        echo "unknown"
    fi
}

auto_install_dependency() {
    local dep=$1
    local pkg_manager=$(detect_package_manager)

    if [[ "$pkg_manager" == "unknown" ]]; then
        return 1
    fi

    echo
    read -p "æ˜¯å¦è‡ªåŠ¨å®‰è£… $dep? (y/n): " -r

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        return 1
    fi

    echo "æ­£åœ¨å®‰è£… $dep..."

    local install_cmd=""
    case "$pkg_manager" in
        apt)
            install_cmd="sudo apt install -y $dep"
            ;;
        dnf)
            install_cmd="sudo dnf install -y $dep"
            ;;
        yum)
            install_cmd="sudo yum install -y $dep"
            ;;
        brew)
            install_cmd="brew install $dep"
            ;;
        pacman)
            install_cmd="sudo pacman -S --noconfirm $dep"
            ;;
        zypper)
            install_cmd="sudo zypper install -y $dep"
            ;;
    esac

    if eval "$install_cmd"; then
        echo -e "${GREEN}âœ“ $dep å®‰è£…æˆåŠŸ${RESET}"
        return 0
    else
        echo -e "${RED}âœ— $dep å®‰è£…å¤±è´¥${RESET}"
        return 1
    fi
}

# ============================================================
# API è°ƒç”¨å‡½æ•°
# ============================================================

api_get_balance() {
    local url="${API_BASE_URL}/api/v1/user/balance"

    # ä½¿ç”¨ curl å‘é€è¯·æ±‚
    local response=$(curl -s -w "\n%{http_code}" \
        -X GET \
        -H "accept: application/json" \
        -H "X-API-Key: ${API_KEY}" \
        --connect-timeout 10 \
        --max-time 30 \
        "$url" 2>&1)

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | sed '$d')

    if [[ "$http_code" == "401" ]]; then
        # è¿”å›ç‰¹æ®Šæ ‡è®°è¡¨ç¤ºè®¤è¯å¤±è´¥
        echo "AUTH_ERROR_401"
        return 2
    fi

    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–ä½™é¢å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    echo "$body"
}

api_get_providers() {
    local url="${API_BASE_URL}/api/v1/user/available-providers"

    # ä½¿ç”¨ curl å‘é€è¯·æ±‚
    local response=$(curl -s -w "\n%{http_code}" \
        -X GET \
        -H "accept: application/json" \
        -H "X-API-Key: ${API_KEY}" \
        --connect-timeout 10 \
        --max-time 30 \
        "$url" 2>&1)

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æ±‚å¤±è´¥${RESET}" >&2
        return 1
    fi

    # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | sed '$d')

    if [[ "$http_code" == "401" ]]; then
        # è¿”å›ç‰¹æ®Šæ ‡è®°è¡¨ç¤ºè®¤è¯å¤±è´¥
        echo "AUTH_ERROR_401"
        return 2
    fi

    if [[ "$http_code" != "200" ]]; then
        echo -e "${RED}è·å–æä¾›å•†ä¿¡æ¯å¤±è´¥: HTTP $http_code${RESET}" >&2
        echo "å“åº”å†…å®¹: $body" >&2
        return 1
    fi

    echo "$body"
}

# ============================================================
# æ˜¾ç¤ºä½™é¢ä¿¡æ¯
# ============================================================

display_balance_info() {
    local data=$1

    # ä½¿ç”¨ jq æå–æ•°æ®
    local subscription_balance=$(echo "$data" | jq -r '.subscription_balance // 0')
    local payg_balance=$(echo "$data" | jq -r '.pay_as_you_go_balance // 0')
    local total_balance=$(echo "$data" | jq -r '.total_balance // 0')
    local credit_balance=$(echo "$data" | jq -r '.credit_balance // 0')
    local weekly_limit=$(echo "$data" | jq -r '.weekly_limit // 0')
    local weekly_spent=$(echo "$data" | jq -r '.weekly_spent_balance // 0')

    # è®¡ç®—å‰©ä½™é¢åº¦å’Œæ¶ˆè´¹ç™¾åˆ†æ¯”
    local weekly_remaining=$(echo "$weekly_limit - $weekly_spent" | bc)
    if (( $(echo "$weekly_limit > 0" | bc -l) )); then
        local spent_percent=$(echo "scale=1; ($weekly_spent / $weekly_limit) * 100" | bc)
        local remaining_percent=$(echo "scale=1; 100 - $spent_percent" | bc)
    else
        local spent_percent=0
        local remaining_percent=0
    fi

    # æ˜¾ç¤ºä½™é¢ä¿¡æ¯
    echo -e "${CYAN}${BOLD}ğŸ’° ä½™é¢ä¿¡æ¯${RESET}"

    if [[ "$subscription_balance" != "0" ]]; then
        local color=$(get_balance_color "$subscription_balance")
        echo -e "è®¢é˜…ä½™é¢ï¼š${color}Â¥$(printf "%.2f" $subscription_balance)${RESET}"
    fi

    if [[ "$payg_balance" != "0" ]]; then
        local color=$(get_balance_color "$payg_balance")
        echo -e "æŒ‰éœ€ä»˜è´¹ä½™é¢ï¼š${color}Â¥$(printf "%.2f" $payg_balance)${RESET}"
    fi

    if [[ "$total_balance" != "0" ]]; then
        local color=$(get_balance_color "$total_balance")
        echo -e "${WHITE}${BOLD}æ€»ä½™é¢ï¼š${RESET}${color}${BOLD}Â¥$(printf "%.2f" $total_balance)${RESET}"
    fi

    if (( $(echo "$credit_balance > 0" | bc -l) )); then
        echo -e "ä¿¡ç”¨é¢åº¦ï¼š${MAGENTA}Â¥$(printf "%.2f" $credit_balance)${RESET}"
    fi

    # æ˜¾ç¤ºæ¶ˆè´¹ä¿¡æ¯
    echo
    echo -e "${CYAN}${BOLD}ğŸ“Š æœ¬å‘¨æ¶ˆè´¹${RESET}"

    if (( $(echo "$weekly_limit > 0" | bc -l) )); then
        echo -e "å‘¨é™é¢ï¼š${CYAN}Â¥$(printf "%.2f" $weekly_limit)${RESET}"

        local color=$(get_spending_color "$spent_percent")
        echo -e "å·²æ¶ˆè´¹ï¼š${color}Â¥$(printf "%.2f" $weekly_spent)${RESET} ${color}(${spent_percent}%)${RESET}"

        local remaining_color=$(get_balance_color "$weekly_remaining")
        echo -e "å‰©ä½™é¢åº¦ï¼š${remaining_color}Â¥$(printf "%.2f" $weekly_remaining)${RESET} ${remaining_color}(${remaining_percent}%)${RESET}"

        echo -e "æ¶ˆè´¹è¿›åº¦ï¼š$(create_progress_bar "$weekly_spent" "$weekly_limit")"
    fi
}

display_providers_info() {
    local data=$1

    # æå–è´¦æˆ·ä¿¡æ¯
    local has_payg=$(echo "$data" | jq -r '.has_payg_balance')
    local has_subscription=$(echo "$data" | jq -r '.has_subscription')

    # æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€
    echo -e "${CYAN}${BOLD}ğŸ”Œ å¯ç”¨æä¾›å•†${RESET}"
    echo

    # ä½¿ç”¨ jq è§£æ providers æ•°ç»„
    local providers_count=$(echo "$data" | jq '.providers | length')

    for ((i=0; i<$providers_count; i++)); do
        local provider_data=$(echo "$data" | jq -r ".providers[$i]")

        local display_name=$(echo "$provider_data" | jq -r '.provider.display_name')
        local type=$(echo "$provider_data" | jq -r '.provider.type')
        local rate=$(echo "$provider_data" | jq -r '.rate_multiplier')
        local is_default=$(echo "$provider_data" | jq -r '.is_default')
        local source=$(echo "$provider_data" | jq -r '.source')

        # è½¬æ¢ source ä¸ºä¸­æ–‡
        local source_text=""
        if [[ "$source" == "subscription" ]]; then
            source_text="${CYAN}è®¢é˜…${RESET}"
        else
            source_text="${YELLOW}æŒ‰éœ€${RESET}"
        fi

        # æ˜¾ç¤ºé»˜è®¤æ ‡è®°
        local default_mark=""
        if [[ "$is_default" == "true" ]]; then
            default_mark=" ${GREEN}[é»˜è®¤]${RESET}"
        fi

        # æ˜¾ç¤ºæä¾›å•†ä¿¡æ¯
        echo -e "${WHITE}${BOLD}${display_name}${RESET}${default_mark}"
        echo -e "  ç±»å‹: ${type}  |  è´¹ç‡: ${MAGENTA}Ã—${rate}${RESET}  |  æ¥æº: ${source_text}"
        echo
    done
}

# ============================================================
# å‘½ä»¤å¤„ç†
# ============================================================

cmd_balance() {
    echo
    echo "æ­£åœ¨æŸ¥è¯¢ä½™é¢..."

    local balance_data
    local exit_code

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e
    balance_data=$(api_get_balance)
    exit_code=$?
    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$balance_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆè®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚
        echo "æ­£åœ¨é‡æ–°æŸ¥è¯¢ä½™é¢..."
        set +e
        balance_data=$(api_get_balance)
        exit_code=$?
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$balance_data" && "$balance_data" != "AUTH_ERROR_401" ]]; then
        echo -e "âœ“ è·å–ä½™é¢ä¿¡æ¯æˆåŠŸ!\n"
        display_balance_info "$balance_data"
    else
        echo -e "${RED}âœ— è·å–ä½™é¢å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_providers() {
    echo
    echo "æ­£åœ¨æŸ¥è¯¢æä¾›å•†..."

    local providers_data
    local exit_code

    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œå…è®¸æ•è·éé›¶é€€å‡ºç 
    set +e
    providers_data=$(api_get_providers)
    exit_code=$?
    set -e

    # å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥ API Key
    if [[ $exit_code -eq 2 && "$providers_data" == "AUTH_ERROR_401" ]]; then
        echo -e "${RED}âœ— API Key æ— æ•ˆï¼ˆ401 è®¤è¯å¤±è´¥ï¼‰${RESET}"
        prompt_api_key false  # ä¸æ˜¾ç¤ºé‡å¤æç¤ºä¿¡æ¯

        # é‡æ–°åŠ è½½é…ç½®
        load_config

        # é‡è¯•è¯·æ±‚
        echo "æ­£åœ¨é‡æ–°æŸ¥è¯¢æä¾›å•†..."
        set +e
        providers_data=$(api_get_providers)
        exit_code=$?
        set -e
    fi

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    if [[ $exit_code -eq 0 && -n "$providers_data" && "$providers_data" != "AUTH_ERROR_401" ]]; then
        echo -e "âœ“ è·å–æä¾›å•†ä¿¡æ¯æˆåŠŸ!\n"
        display_providers_info "$providers_data"
    else
        echo -e "${RED}âœ— è·å–æä¾›å•†ä¿¡æ¯å¤±è´¥${RESET}"
        exit 1
    fi
}

cmd_uninstall() {
    # è·å– yc å‘½ä»¤çš„å®é™…è·¯å¾„
    local yc_path=""

    # æ–¹æ³•1ï¼šå¦‚æœæ˜¯é€šè¿‡å®‰è£…çš„å‘½ä»¤è¿è¡Œï¼Œä½¿ç”¨ which æŸ¥æ‰¾
    if command -v yc &> /dev/null; then
        yc_path=$(which yc)
    fi

    # æ–¹æ³•2ï¼šå¦‚æœæ˜¯ç›´æ¥è¿è¡Œè„šæœ¬ï¼Œä½¿ç”¨ $0
    if [[ -z "$yc_path" || "$yc_path" == *"/"* ]]; then
        yc_path=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™åˆ é™¤
    if [[ ! -w "$yc_path" && ! -w "$(dirname "$yc_path")" ]]; then
        echo -e "${RED}âœ— æ²¡æœ‰æƒé™åˆ é™¤ $yc_path${RESET}"
        echo "è¯·ä½¿ç”¨ sudo è¿è¡Œæˆ–æ‰‹åŠ¨åˆ é™¤"
        exit 1
    fi

    # è¯¢é—®æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶
    local delete_config=false
    if [[ -f "$HOME/.yescode/config.json" ]]; then
        echo
        read -p "æ˜¯å¦åŒæ—¶åˆ é™¤é…ç½®æ–‡ä»¶? (y/n): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            delete_config=true
        fi
    fi

    # åˆ é™¤ yc å‘½ä»¤
    if rm -f "$yc_path" 2>/dev/null; then
        echo -e "${GREEN}âœ“ å·²å¸è½½ yc${RESET}"
    else
        echo -e "${RED}âœ— å¸è½½å¤±è´¥${RESET}"
        exit 1
    fi

    # åˆ é™¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©ï¼‰
    if [[ "$delete_config" == true ]]; then
        rm -rf "$HOME/.yescode" 2>/dev/null
        echo -e "${GREEN}âœ“ å·²åˆ é™¤é…ç½®æ–‡ä»¶${RESET}"
    fi
}

cmd_install() {
    # æ£€æŸ¥ä¾èµ–
    local missing_deps=()

    if ! command -v curl &> /dev/null; then
        missing_deps+=("curl")
    fi

    if ! command -v jq &> /dev/null; then
        missing_deps+=("jq")
    fi

    # å¦‚æœæœ‰ç¼ºå¤±çš„ä¾èµ–ï¼Œå°è¯•è‡ªåŠ¨å®‰è£…
    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo -e "${YELLOW}âš  ç¼ºå°‘ä¾èµ–: ${missing_deps[*]}${RESET}"

        local pkg_manager=$(detect_package_manager)

        if [[ "$pkg_manager" != "unknown" ]]; then
            # å°è¯•è‡ªåŠ¨å®‰è£…æ¯ä¸ªç¼ºå¤±çš„ä¾èµ–
            for dep in "${missing_deps[@]}"; do
                if auto_install_dependency "$dep"; then
                    # å®‰è£…æˆåŠŸï¼Œä»ç¼ºå¤±åˆ—è¡¨ä¸­ç§»é™¤
                    missing_deps=("${missing_deps[@]/$dep}")
                fi
            done

            # è¿‡æ»¤ç©ºå…ƒç´ 
            missing_deps=($(printf '%s\n' "${missing_deps[@]}" | grep -v '^$'))
        fi

        # é‡æ–°æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç¼ºå¤±
        if [ ${#missing_deps[@]} -gt 0 ]; then
            echo
            echo -e "${YELLOW}âš  ä¾èµ–ä»ç„¶ç¼ºå¤±: ${missing_deps[*]}${RESET}"
            echo "è¯·æ‰‹åŠ¨å®‰è£…ï¼š"
            echo "  Ubuntu/Debian: sudo apt install ${missing_deps[*]}"
            echo "  RHEL/CentOS: sudo yum install ${missing_deps[*]}"
            echo "  Fedora: sudo dnf install ${missing_deps[*]}"
            echo "  macOS: brew install ${missing_deps[*]}"
            echo "  Arch Linux: sudo pacman -S ${missing_deps[*]}"
            echo
            read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/n): " -r
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "å·²å–æ¶ˆ"
                exit 1
            fi
        fi
    fi

    # è·å–å½“å‰è„šæœ¬è·¯å¾„
    local script_path=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")

    # ç¡®å®šå®‰è£…ç›®æ ‡ç›®å½•
    local install_dir=""
    if [ -w "/usr/local/bin" ]; then
        install_dir="/usr/local/bin"
    elif [ -d "$HOME/.local/bin" ]; then
        install_dir="$HOME/.local/bin"
    else
        install_dir="$HOME/.local/bin"
        mkdir -p "$install_dir"
    fi

    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    local install_path="$install_dir/yc"
    if [ -f "$install_path" ]; then
        if [ "$script_path" = "$install_path" ]; then
            echo -e "${CYAN}â„¹ yc å·²å®‰è£…${RESET}"
            return 0
        fi
    fi

    # å®‰è£…è„šæœ¬æ–‡ä»¶
    if cp "$script_path" "$install_path" 2>/dev/null; then
        chmod +x "$install_path"
        echo -e "${GREEN}âœ“ å·²å®‰è£…åˆ° $install_path${RESET}"
    else
        echo -e "${RED}âœ— å®‰è£…å¤±è´¥ï¼Œæ²¡æœ‰æƒé™å†™å…¥ $install_dir${RESET}"
        echo "è¯·ä½¿ç”¨ sudo è¿è¡Œ"
        exit 1
    fi

    # é…ç½® API Key
    local config_dir="$HOME/.yescode"
    local config_file="$config_dir/config.json"

    if [ ! -f "$config_file" ]; then
        mkdir -p "$config_dir"
        echo
        read -p "é…ç½® API Key: " api_key
    fi

    # æ£€æŸ¥ PATH
    if [[ ":$PATH:" != *":$install_dir:"* ]]; then
        echo
        echo -e "${YELLOW}âš  $install_dir ä¸åœ¨ PATH ä¸­${RESET}"
        echo "è¯·æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc:"
        echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi
}

show_help() {
    cat << EOF
usage: yc [-h] {balance,providers,install,uninstall}

YesCode API è°ƒç”¨å·¥å…· - æŸ¥è¯¢ä½™é¢ã€æä¾›å•†ç­‰åŠŸèƒ½

positional arguments:
  balance     æŸ¥è¯¢è´¦æˆ·ä½™é¢å’Œè®¢é˜…ä¿¡æ¯
  providers   æŸ¥è¯¢å¯ç”¨çš„ AI æä¾›å•†
  install     å®‰è£… yc å‘½ä»¤åˆ°ç³»ç»Ÿ
  uninstall   å¸è½½ yc å‘½ä»¤

options:
  -h, --help  æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ä½¿ç”¨ç¤ºä¾‹:
  yc balance                          # æŸ¥è¯¢ä½™é¢
  yc providers                        # æŸ¥è¯¢æä¾›å•†
  yc install                          # å®‰è£… yc
  yc uninstall                        # å¸è½½ yc
  yc --help                           # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
EOF
}

# ============================================================
# ä¸»ç¨‹åº
# ============================================================

main() {
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    if [[ $# -eq 0 ]]; then
        show_help
        exit 1
    fi

    # å¤„ç†ä¸éœ€è¦ä¾èµ–æ£€æŸ¥çš„å‘½ä»¤
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        install)
            cmd_install
            exit 0
            ;;
        uninstall)
            cmd_uninstall
            exit 0
            ;;
    esac

    # æ£€æŸ¥ä¾èµ–ï¼ˆbalance ç­‰å‘½ä»¤éœ€è¦ï¼‰
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° jq å‘½ä»¤${RESET}"
        echo "è¯·å®‰è£… jq: apt install jq (Ubuntu/Debian) æˆ– brew install jq (macOS)"
        exit 1
    fi

    if ! command -v curl &> /dev/null; then
        echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° curl å‘½ä»¤${RESET}"
        echo "è¯·å®‰è£… curl: apt install curl (Ubuntu/Debian) æˆ– brew install curl (macOS)"
        exit 1
    fi

    # å¤„ç†éœ€è¦ä¾èµ–çš„å‘½ä»¤
    case "$1" in
        balance)
            load_config
            cmd_balance
            ;;
        providers)
            load_config
            cmd_providers
            ;;
        *)
            echo -e "${RED}é”™è¯¯: æœªçŸ¥å‘½ä»¤ '$1'${RESET}"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"
